<![CDATA[<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Emulator 可视化窗口</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --panel: #1e293b;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #22c55e;
      --warn: #f59e0b;
      --danger: #ef4444;
      --link: #60a5fa;
      --border: #334155;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif;
      background: linear-gradient(180deg, #0b1220, #0f172a);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(30, 41, 59, 0.35);
      backdrop-filter: blur(6px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      margin: 0 0 8px 0;
      font-weight: 600;
      letter-spacing: 0.2px;
    }
    .muted { color: var(--muted); font-size: 14px; }

    .card {
      background: linear-gradient(180deg, rgba(30,41,59,0.8), rgba(15,23,42,0.9));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
      margin-top: 16px;
    }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 8px 12px; border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(51,65,85,0.3);
      color: var(--text); cursor: pointer; text-decoration: none;
    }
    .btn:hover { background: rgba(51,65,85,0.5); }
    input, select {
      background: #0b1220; color: var(--text);
      border: 1px solid var(--border);
      outline: none; border-radius: 8px; padding: 8px 10px;
    }
    select:focus { border-color: #334155; }

    iframe.viewer {
      width: 100%;
      height: 70vh;
      min-height: 480px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #0b1220;
    }
    .info {
      color: var(--muted);
      font-size: 13px;
    }
    .danger-txt { color: var(--danger); }
    .link { color: var(--link); }
    code { background: #0b1220; border: 1px solid var(--border); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Emulator 可视化窗口</h1>
      <div class="muted">从 /emulators 读取可用实例，选择后在下方以 iframe 展示对应 VNC 页面</div>
    </div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row">
        <label for="emuSelect">选择 Emulator：</label>
        <select id="emuSelect"></select>
        <a id="openLink" class="btn" href="#" target="_blank" rel="noopener">在新标签打开</a>
        <span id="status" class="info"></span>
      </div>
      <div style="margin-top:12px;">
        <iframe id="vncFrame" class="viewer" src="about:blank"></iframe>
      </div>
      <div style="margin-top:8px;" class="info">
        注意：若目标 VNC 服务设置了 X-Frame-Options 或 CSP 禁止嵌入，iframe 可能无法显示，可点击“在新标签打开”直接访问。
      </div>
    </section>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const emuSelect = $("emuSelect");
    const vncFrame = $("vncFrame");
    const openLink = $("openLink");
    const statusEl = $("status");

    let emulators = [];
    let selectedId = null;

    const buildVncUrl = (emu) => {
      // 构造 VNC 访问地址：协议 + 主机名 + vnc_port
      return `${location.protocol}//${location.hostname}:${emu.vnc_port}`;
    };

    function labelForEmulator(emu) {
      const eid = emu.emulator_id || "-";
      const token = emu.token || "-";
      const ports = `${emu.server_port}/${emu.chromium_port}/${emu.vnc_port}/${emu.vlc_port}`;
      // 显示前 8 位，避免过长
      const shortId = eid.length > 8 ? eid.slice(0, 8) : eid;
      return `${shortId} (token:${token}) [ports ${ports}]`;
    }

    function populateSelect() {
      emuSelect.innerHTML = "";
      if (!emulators || emulators.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "无活动的 emulator";
        emuSelect.appendChild(opt);
        selectedId = null;
        setViewer(null);
        statusEl.textContent = "当前没有可用的 emulator 实例。";
        return;
      }
      let keep = selectedId;
      const ids = new Set(emulators.map(e => e.emulator_id));
      if (!keep || !ids.has(keep)) {
        keep = emulators[0].emulator_id;
      }
      emulators.forEach(emu => {
        const opt = document.createElement("option");
        opt.value = emu.emulator_id;
        opt.textContent = labelForEmulator(emu);
        if (emu.emulator_id === keep) {
          opt.selected = true;
        }
        emuSelect.appendChild(opt);
      });
      if (keep !== selectedId) {
        selectedId = keep;
        setViewer(findById(selectedId));
      } else {
        // 即使保持原选择，仍刷新链接与状态
        setViewer(findById(selectedId), false);
      }
    }

    function findById(eid) {
      return (emulators || []).find(e => e.emulator_id === eid);
    }

    function setViewer(emu, updateSelect = true) {
      if (!emu) {
        vncFrame.src = "about:blank";
        openLink.href = "#";
        openLink.setAttribute("aria-disabled", "true");
        statusEl.textContent = "";
        return;
      }
      const url = buildVncUrl(emu);
      vncFrame.src = url;
      openLink.href = url;
      openLink.removeAttribute("aria-disabled");
      statusEl.textContent = `VNC端口：${emu.vnc_port} | Emulator: ${emu.emulator_id}`;
      if (updateSelect) {
        const opt = [...emuSelect.options].find(o => o.value === emu.emulator_id);
        if (opt) opt.selected = true;
      }
    }

    async function refreshEmulators() {
      try {
        const resp = await fetch("/emulators");
        const arr = await resp.json();
        if (Array.isArray(arr)) {
          emulators = arr;
        } else {
          emulators = [];
        }
        populateSelect();
      } catch (e) {
        console.error(e);
        statusEl.textContent = "获取 /emulators 列表失败";
      }
    }

    emuSelect.addEventListener("change", (ev) => {
      const eid = ev.target.value;
      selectedId = eid || null;
      setViewer(findById(selectedId));
    });

    // 初次载入 + 定时刷新
    refreshEmulators();
    setInterval(refreshEmulators, 5000);
  </script>
</body>
</html>]]>
